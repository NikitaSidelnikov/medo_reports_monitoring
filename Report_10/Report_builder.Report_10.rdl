<?xml version="1.0" encoding="utf-8"?>
<Report xmlns:rd="http://schemas.microsoft.com/SQLServer/reporting/reportdesigner" xmlns:cl="http://schemas.microsoft.com/sqlserver/reporting/2010/01/componentdefinition" xmlns="http://schemas.microsoft.com/sqlserver/reporting/2010/01/reportdefinition">
  <AutoRefresh>0</AutoRefresh>
  <DataSources>
    <DataSource Name="DataSource1">
      <ConnectionProperties>
        <DataProvider>SQL</DataProvider>
        <ConnectString>Data Source=(local);Initial Catalog=medomon</ConnectString>
        <IntegratedSecurity>true</IntegratedSecurity>
      </ConnectionProperties>
      <rd:SecurityType>Integrated</rd:SecurityType>
      <rd:DataSourceID>f898c071-9876-4786-8c4e-ce8582d7ac8c</rd:DataSourceID>
    </DataSource>
  </DataSources>
  <DataSets>
    <DataSet Name="DataSet1">
      <Query>
        <DataSourceName>DataSource1</DataSourceName>
        <QueryParameters>
          <QueryParameter Name="@DataStart">
            <Value>=Parameters!DataStart.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@DataEnd">
            <Value>=Parameters!DataEnd.Value</Value>
          </QueryParameter>
        </QueryParameters>
        <CommandText>--DECLARE @DataStart DateTime2
--DECLARE @DataEnd DateTime2
--SET @DataStart = '2021-03-01'
--SET @DataEnd = '2021-04-01'

if object_id('tempdb..#tmp') is not null
	DROP TABLE #tmp
if object_id('tempdb..#tmp2') is not null
	DROP TABLE #tmp2

CREATE TABLE #tmp (Rank INT, SenderGuid nvarchar(255), RecipientGuid nvarchar(255), CountNewVersionED INT, CountActiveCommunications INT, ALLCountNewVersionED INT)

INSERT INTO #tmp  
SELECT 	--оценка переписок с рангом
	DENSE_RANK() OVER (ORDER BY CountActiveCommunications DESC, ALLCountNewVersionED DESC, Member.Name ASC) AS Rank
	,SenderGuid
	,RecipientGuid
	,CountNewVersionED
	,CountActiveCommunications
	,ALLCountNewVersionED
FROM (
	SELECT	--оценка переписок
		CommunicationsControl.SenderGuid
		,CommunicationsControl.RecipientGuid
		,IsNull(CommunicationsControl.CountNewVersionED, -1) AS CountNewVersionED --где переписки нет, там -1
		,SUM(CommunicationsControl.CountNewVersionED) OVER (PARTITION BY CommunicationsControl.SenderGuid) AS ALLCountNewVersionED --сумма всех ЭД в формате 2.7.1 по участнику 
		,SUM(IIF(CommunicationsControl.CountNewVersionED &gt; 2, 1, 0)) OVER (PARTITION BY CommunicationsControl.SenderGuid) AS CountActiveCommunications --если в переписке есть более 2 ЭД 2.7.1, то +1 к активной переписке
	FROM ( --CommunicationsControl = коммуникаций Sender и Recipient и кол-во версий 2.7.1 ЭД
		SELECT
			AllCommunications.SenderGuid
			,AllCommunications.RecipientGuid
			,NewVersionControl.CountNewVersionED
		FROM ( --AllCommunications = Все возможные варианты коммуникаций Sender и Recipient
			SELECT 
				Member1.Name		AS Sender
				,Member1.Guid	AS SenderGuid
				,Member2.Name	AS Recipient 
				,Member2.Guid	AS RecipientGuid 
			FROM 
				Member AS Member1
			CROSS JOIN (
				SELECT 
					Member.Name
					,Member.Guid
					,Member.Active
				FROM 
					Member
			) AS Member2
			WHERE 
				Member1.Active = 1
				AND Member2.Active = 1
		) AS AllCommunications
		LEFT JOIN (
			SELECT -- NewVersionControl = коммуникации MemberY и MemberX в период отчета по ЭД с указанием кол-ва версий 2.7.1 ЭД
				VersionControl.MemberY
				,VersionControl.MemberX
				,SUM(IIF(VersionControl.VersionED = '2.7.1', 1, 0)) AS CountNewVersionED
			FROM (
				SELECT  -- VersionControl Все коммуникации MemberY и MemberX в период отчета по ЭД с указанием версии ЭД
					ConfirmationControl.SenderGuid AS MemberY		--отправитель
					,ConfirmationControl.RecipientGuid AS MemberX	--получатель
					,IIF(ConfirmationControl.MessageType = N'Транспортный контейнер', ValidationLog.ContainerXmlVersion, ValidationLog.PackageXmlVersion) AS VersionED
				FROM	
					ConfirmationControl	
				INNER JOIN ValidationLog
					ON ValidationLog.Id = ConfirmationControl.ValidatingLog
				WHERE 
					--ConfirmationControl.PackageDelivaredOn &gt;= '2021-02-28' --конец периода отчета
					--AND ConfirmationControl.PackageDelivaredOn &lt; '2021-03-29' --конец периода отчета		
					ConfirmationControl.PackageDelivaredOn &gt;=  DATETIMEFROMPARTS(DATEPART(YEAR, @DataStart), DATEPART(MONTH, @DataStart), DATEPART(DAY, @DataStart), '0', '0', '0', '0') --начало периода отчета
					AND ConfirmationControl.PackageDelivaredOn &lt; DATETIMEFROMPARTS(DATEPART(YEAR, @DataEnd), DATEPART(MONTH, @DataEnd), DATEPART(DAY, @DataEnd), '23', '59', '59', '0') --конец периода отчета
					AND(ConfirmationControl.MessageType = N'Транспортный контейнер' OR ConfirmationControl.MessageType = N'Документ')
			) AS VersionControl
			GROUP BY
				VersionControl.MemberY
				,VersionControl.MemberX
		) AS NewVersionControl
			ON AllCommunications.SenderGuid = NewVersionControl.MemberY
			AND AllCommunications.RecipientGuid = NewVersionControl.MemberX
			) AS CommunicationsControl	
) AS A
INNER JOIN Member
	ON Member.Guid = A.SenderGuid

CREATE TABLE #tmp2 (Rank INT, SenderGuid nvarchar(255)) --чтобы сортировать столбец так же, как и строку
INSERT INTO #tmp2  
	SELECT 
		distinct
		#tmp.Rank
		,#tmp.SenderGuid
	FROM #tmp

SELECT
	Report10.RankA
	,MemberSender.Name AS Sender
	,Report10.SenderGuid
	,Report10.RankB 
	,MemberRecipient.Name AS Recipient
	,Report10.RecipientGuid
	,Report10.CountNewVersionED
	,Report10.CountActiveCommunications
	,Report10.ALLCountNewVersionED	
FROM (
	SELECT 
		A.Rank AS RankA
		,A.SenderGuid
		,B.Rank AS RankB
		,A.RecipientGuid
		,A.CountNewVersionED
		,A.CountActiveCommunications
		,A.ALLCountNewVersionED	
	FROM #tmp AS A
	INNER JOIN #tmp2 AS B
		ON A.RecipientGuid = B.SenderGuid
) AS Report10
INNER JOIN Member AS MemberSender
	ON MemberSender.Guid = Report10.SenderGuid COLLATE SQL_Latin1_General_CP1_CI_AS
INNER JOIN Member AS MemberRecipient
	ON MemberRecipient.Guid = Report10.RecipientGuid COLLATE SQL_Latin1_General_CP1_CI_AS

</CommandText>
        <rd:UseGenericDesigner>true</rd:UseGenericDesigner>
      </Query>
      <Fields>
        <Field Name="Sender">
          <DataField>Sender</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="RankA">
          <DataField>RankA</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
        <Field Name="Recipient">
          <DataField>Recipient</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="SenderGuid">
          <DataField>SenderGuid</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="CountNewVersionED">
          <DataField>CountNewVersionED</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
        <Field Name="RankB">
          <DataField>RankB</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
        <Field Name="CountActiveCommunications">
          <DataField>CountActiveCommunications</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
        <Field Name="RecipientGuid">
          <DataField>RecipientGuid</DataField>
          <rd:TypeName>System.String</rd:TypeName>
        </Field>
        <Field Name="ALLCountNewVersionED">
          <DataField>ALLCountNewVersionED</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
      </Fields>
    </DataSet>
    <DataSet Name="DataSet2">
      <Query>
        <DataSourceName>DataSource1</DataSourceName>
        <QueryParameters>
          <QueryParameter Name="@DataStart">
            <Value>=Parameters!DataStart.Value</Value>
          </QueryParameter>
          <QueryParameter Name="@DataEnd">
            <Value>=Parameters!DataEnd.Value</Value>
          </QueryParameter>
        </QueryParameters>
        <CommandText>SELECT
	MAX(SumVersionControl.CountNewVersionED) AS MaxCountED
FROM (
	SELECT -- SumVersionControl = Кол-во переданных ЭД в формате 2.7.1 по каждому участнику
		VersionControl.MemberY
		,SUM(IIF(VersionControl.VersionED = '2.7.1', 1, 0)) AS CountNewVersionED
	FROM (
		SELECT  --VersionControl = Переданные ЭД в формате 2.7.1
			ConfirmationControl.SenderGuid AS MemberY		--отправитель
			,ConfirmationControl.RecipientGuid AS MemberX
			,IIF(ConfirmationControl.MessageType = N'Транспортный контейнер', ValidationLog.ContainerXmlVersion, ValidationLog.PackageXmlVersion) AS VersionED
		FROM	
			ConfirmationControl	
		INNER JOIN ValidationLog
			ON ValidationLog.Id = ConfirmationControl.ValidatingLog
		WHERE 
			--ConfirmationControl.PackageDelivaredOn &gt;= '2021-02-28' --конец периода отчета
			--AND ConfirmationControl.PackageDelivaredOn &lt; '2021-03-29' --конец периода отчета		
			ConfirmationControl.PackageDelivaredOn &gt;=  DATETIMEFROMPARTS(DATEPART(YEAR, @DataStart), DATEPART(MONTH, @DataStart), DATEPART(DAY, @DataStart), '0', '0', '0', '0') --начало периода отчета
			AND ConfirmationControl.PackageDelivaredOn &lt; DATETIMEFROMPARTS(DATEPART(YEAR, @DataEnd), DATEPART(MONTH, @DataEnd), DATEPART(DAY, @DataEnd), '23', '59', '59', '0') --конец периода отчета
			AND(ConfirmationControl.MessageType = N'Транспортный контейнер' OR ConfirmationControl.MessageType = N'Документ')
	) AS VersionControl
	GROUP BY
		VersionControl.MemberY
		,VersionControl.MemberX
) AS SumVersionControl</CommandText>
      </Query>
      <Fields>
        <Field Name="MaxCountED">
          <DataField>MaxCountED</DataField>
          <rd:TypeName>System.Int32</rd:TypeName>
        </Field>
      </Fields>
    </DataSet>
  </DataSets>
  <ReportSections>
    <ReportSection>
      <Body>
        <ReportItems>
          <Textbox Name="ReportTitle">
            <CanGrow>true</CanGrow>
            <CanShrink>true</CanShrink>
            <KeepTogether>true</KeepTogether>
            <Paragraphs>
              <Paragraph>
                <TextRuns>
                  <TextRun>
                    <Value>Кросс-таблица по использованию формата 2.7.1 при обмене электронными документами</Value>
                    <Style>
                      <FontFamily>Yu Gothic UI Light</FontFamily>
                      <FontSize>20pt</FontSize>
                    </Style>
                  </TextRun>
                </TextRuns>
                <Style>
                  <TextAlign>Left</TextAlign>
                </Style>
              </Paragraph>
            </Paragraphs>
            <rd:WatermarkTextbox>Title</rd:WatermarkTextbox>
            <rd:DefaultName>ReportTitle</rd:DefaultName>
            <Top>0mm</Top>
            <Left>0cm</Left>
            <Height>9.99718mm</Height>
            <Width>278.25789mm</Width>
            <Style>
              <Border>
                <Style>None</Style>
              </Border>
              <VerticalAlign>Top</VerticalAlign>
              <PaddingLeft>2pt</PaddingLeft>
              <PaddingRight>2pt</PaddingRight>
              <PaddingTop>2pt</PaddingTop>
              <PaddingBottom>2pt</PaddingBottom>
            </Style>
          </Textbox>
          <Textbox Name="DataEnd">
            <CanGrow>true</CanGrow>
            <CanShrink>true</CanShrink>
            <KeepTogether>true</KeepTogether>
            <Paragraphs>
              <Paragraph>
                <TextRuns>
                  <TextRun>
                    <Value>=Format(DateAdd("s", -1, DateAdd("d", 1, Parameters!DataEnd.Value)), "dd MMM yyyy")</Value>
                    <Style>
                      <FontFamily>Yu Gothic UI</FontFamily>
                      <Format>d MMMM yyyy 'г.' H:mm:ss</Format>
                    </Style>
                  </TextRun>
                </TextRuns>
                <Style>
                  <TextAlign>Left</TextAlign>
                </Style>
              </Paragraph>
            </Paragraphs>
            <rd:DefaultName>DataEnd</rd:DefaultName>
            <Top>11.76107mm</Top>
            <Left>59.60123mm</Left>
            <Height>6mm</Height>
            <Width>47.78986mm</Width>
            <ZIndex>1</ZIndex>
            <Visibility>
              <Hidden>=IsNothing(Parameters!DataEnd.Value)</Hidden>
            </Visibility>
            <Style>
              <Border>
                <Style>None</Style>
              </Border>
              <PaddingLeft>2pt</PaddingLeft>
              <PaddingRight>2pt</PaddingRight>
              <PaddingTop>2pt</PaddingTop>
              <PaddingBottom>2pt</PaddingBottom>
            </Style>
          </Textbox>
          <Textbox Name="Textbox61">
            <CanGrow>true</CanGrow>
            <CanShrink>true</CanShrink>
            <KeepTogether>true</KeepTogether>
            <Paragraphs>
              <Paragraph>
                <TextRuns>
                  <TextRun>
                    <Value>по</Value>
                    <Style>
                      <FontFamily>Yu Gothic UI</FontFamily>
                    </Style>
                  </TextRun>
                </TextRuns>
                <Style>
                  <TextAlign>Left</TextAlign>
                </Style>
              </Paragraph>
            </Paragraphs>
            <rd:DefaultName>Textbox60</rd:DefaultName>
            <Top>11.76107mm</Top>
            <Left>53.94104mm</Left>
            <Height>6mm</Height>
            <Width>5.66019mm</Width>
            <ZIndex>2</ZIndex>
            <Visibility>
              <Hidden>=IsNothing(Parameters!DataEnd.Value)</Hidden>
            </Visibility>
            <Style>
              <Border>
                <Style>None</Style>
              </Border>
              <PaddingLeft>2pt</PaddingLeft>
              <PaddingRight>2pt</PaddingRight>
              <PaddingTop>2pt</PaddingTop>
              <PaddingBottom>2pt</PaddingBottom>
            </Style>
          </Textbox>
          <Textbox Name="DataStart">
            <CanGrow>true</CanGrow>
            <CanShrink>true</CanShrink>
            <KeepTogether>true</KeepTogether>
            <Paragraphs>
              <Paragraph>
                <TextRuns>
                  <TextRun>
                    <Value>=Format(Parameters!DataStart.Value, "dd MMM yyyy")</Value>
                    <Style>
                      <FontFamily>Yu Gothic UI</FontFamily>
                      <Format>d MMMM yyyy 'г.' H:mm:ss</Format>
                    </Style>
                  </TextRun>
                </TextRuns>
                <Style>
                  <TextAlign>Left</TextAlign>
                </Style>
              </Paragraph>
            </Paragraphs>
            <rd:DefaultName>DataStart</rd:DefaultName>
            <Top>11.76107mm</Top>
            <Left>32.12609mm</Left>
            <Height>6mm</Height>
            <Width>21.81495mm</Width>
            <ZIndex>3</ZIndex>
            <Visibility>
              <Hidden>=IsNothing(Parameters!DataStart.Value)</Hidden>
            </Visibility>
            <Style>
              <Border>
                <Style>None</Style>
              </Border>
              <PaddingLeft>2pt</PaddingLeft>
              <PaddingRight>2pt</PaddingRight>
              <PaddingTop>2pt</PaddingTop>
              <PaddingBottom>2pt</PaddingBottom>
            </Style>
          </Textbox>
          <Textbox Name="Textbox60">
            <CanGrow>true</CanGrow>
            <CanShrink>true</CanShrink>
            <KeepTogether>true</KeepTogether>
            <Paragraphs>
              <Paragraph>
                <TextRuns>
                  <TextRun>
                    <Value>с</Value>
                    <Style>
                      <FontFamily>Yu Gothic UI</FontFamily>
                    </Style>
                  </TextRun>
                </TextRuns>
                <Style>
                  <TextAlign>Left</TextAlign>
                </Style>
              </Paragraph>
            </Paragraphs>
            <rd:DefaultName>Textbox60</rd:DefaultName>
            <Top>11.76107mm</Top>
            <Left>28.96874mm</Left>
            <Height>6mm</Height>
            <Width>3.15735mm</Width>
            <ZIndex>4</ZIndex>
            <Visibility>
              <Hidden>=IsNothing(Parameters!DataStart.Value)</Hidden>
            </Visibility>
            <Style>
              <Border>
                <Style>None</Style>
              </Border>
              <PaddingLeft>2pt</PaddingLeft>
              <PaddingRight>2pt</PaddingRight>
              <PaddingTop>2pt</PaddingTop>
              <PaddingBottom>2pt</PaddingBottom>
            </Style>
          </Textbox>
          <Textbox Name="Textbox63">
            <CanGrow>true</CanGrow>
            <CanShrink>true</CanShrink>
            <KeepTogether>true</KeepTogether>
            <Paragraphs>
              <Paragraph>
                <TextRuns>
                  <TextRun>
                    <Value>Период отчета:</Value>
                    <Style>
                      <FontFamily>Yu Gothic UI</FontFamily>
                      <FontWeight>Bold</FontWeight>
                    </Style>
                  </TextRun>
                </TextRuns>
                <Style />
              </Paragraph>
            </Paragraphs>
            <rd:DefaultName>Textbox59</rd:DefaultName>
            <Top>11.76107mm</Top>
            <Left>0mm</Left>
            <Height>6mm</Height>
            <Width>28.96874mm</Width>
            <ZIndex>5</ZIndex>
            <Style>
              <Border>
                <Style>None</Style>
              </Border>
              <PaddingLeft>2pt</PaddingLeft>
              <PaddingRight>2pt</PaddingRight>
              <PaddingTop>2pt</PaddingTop>
              <PaddingBottom>2pt</PaddingBottom>
            </Style>
          </Textbox>
          <Tablix Name="Tablix1">
            <TablixCorner>
              <TablixCornerRows>
                <TablixCornerRow>
                  <TablixCornerCell>
                    <CellContents>
                      <Textbox Name="Textbox20">
                        <KeepTogether>true</KeepTogether>
                        <Paragraphs>
                          <Paragraph>
                            <TextRuns>
                              <TextRun>
                                <Value xml:space="preserve"> </Value>
                                <Style>
                                  <FontFamily>Tahoma</FontFamily>
                                  <FontSize>8pt</FontSize>
                                  <FontWeight>Normal</FontWeight>
                                  <Color>Gray</Color>
                                </Style>
                              </TextRun>
                              <TextRun>
                                <Value> Примечание по заполнению кросс-таблицы:
</Value>
                                <Style>
                                  <FontFamily>Tahoma</FontFamily>
                                  <FontSize>8pt</FontSize>
                                  <FontWeight>Normal</FontWeight>
                                  <TextDecoration>Underline</TextDecoration>
                                  <Color>Gray</Color>
                                </Style>
                              </TextRun>
                              <TextRun>
                                <Value>
    По строкам -- участники в роли отправителя
    По столбцам -- участники в роли получателя</Value>
                                <Style>
                                  <FontFamily>Tahoma</FontFamily>
                                  <FontSize>8pt</FontSize>
                                  <FontWeight>Normal</FontWeight>
                                  <Color>Gray</Color>
                                </Style>
                              </TextRun>
                            </TextRuns>
                            <Style>
                              <TextAlign>Left</TextAlign>
                            </Style>
                          </Paragraph>
                          <Paragraph>
                            <TextRuns>
                              <TextRun>
                                <Value>
    Зелёным отмечены отправители, готовые к работе в 2.7.1 (направили более 2-х писем 3 или более адресатам)
    Жёлтым отмечены отправители, частично готовые к 2.7.1 (направили более 2-х писем 1 или 2 адресатам)
    Красным отмечены отправители, не готовые к 2.7.1

    В ячейках -- количество электронных документов, направленных отправителем  получателю в 2.7.1
    Зелёным цветом ячеек отмечена активная переписка (если направлено более 2-х документов)</Value>
                                <Style>
                                  <FontFamily>Tahoma</FontFamily>
                                  <FontSize>8pt</FontSize>
                                  <FontWeight>Normal</FontWeight>
                                  <Color>Gray</Color>
                                </Style>
                              </TextRun>
                            </TextRuns>
                            <Style>
                              <TextAlign>Left</TextAlign>
                            </Style>
                          </Paragraph>
                        </Paragraphs>
                        <rd:DefaultName>Textbox20</rd:DefaultName>
                        <Style>
                          <Border>
                            <Color>#7292cc</Color>
                            <Style>None</Style>
                          </Border>
                          <BottomBorder>
                            <Color>#4e648a</Color>
                            <Style>Solid</Style>
                          </BottomBorder>
                          <BackgroundColor>White</BackgroundColor>
                          <VerticalAlign>Bottom</VerticalAlign>
                          <PaddingLeft>2pt</PaddingLeft>
                          <PaddingRight>2pt</PaddingRight>
                          <PaddingTop>2pt</PaddingTop>
                          <PaddingBottom>2pt</PaddingBottom>
                        </Style>
                      </Textbox>
                    </CellContents>
                  </TablixCornerCell>
                  <TablixCornerCell>
                    <CellContents>
                      <Textbox Name="Textbox6">
                        <KeepTogether>true</KeepTogether>
                        <Paragraphs>
                          <Paragraph>
                            <TextRuns>
                              <TextRun>
                                <Value>Итого адресатов с активной перепиской</Value>
                                <Style>
                                  <FontFamily>Tahoma</FontFamily>
                                  <FontSize>9pt</FontSize>
                                  <FontWeight>Normal</FontWeight>
                                  <Color>Gray</Color>
                                </Style>
                              </TextRun>
                            </TextRuns>
                            <Style>
                              <TextAlign>Left</TextAlign>
                            </Style>
                          </Paragraph>
                        </Paragraphs>
                        <rd:DefaultName>Textbox1</rd:DefaultName>
                        <Style>
                          <Border>
                            <Color>White</Color>
                            <Style>None</Style>
                          </Border>
                          <BottomBorder>
                            <Color>#4e648a</Color>
                            <Style>Solid</Style>
                          </BottomBorder>
                          <BackgroundColor>White</BackgroundColor>
                          <VerticalAlign>Middle</VerticalAlign>
                          <PaddingLeft>2pt</PaddingLeft>
                          <PaddingRight>2pt</PaddingRight>
                          <PaddingTop>2pt</PaddingTop>
                          <PaddingBottom>6pt</PaddingBottom>
                          <WritingMode>Rotate270</WritingMode>
                        </Style>
                      </Textbox>
                    </CellContents>
                  </TablixCornerCell>
                  <TablixCornerCell>
                    <CellContents>
                      <Textbox Name="Textbox4">
                        <KeepTogether>true</KeepTogether>
                        <Paragraphs>
                          <Paragraph>
                            <TextRuns>
                              <TextRun>
                                <Value>Итого отправлено ЭД в формате 2.7.1</Value>
                                <Style>
                                  <FontFamily>Tahoma</FontFamily>
                                  <FontSize>9pt</FontSize>
                                  <FontWeight>Normal</FontWeight>
                                  <Color>Gray</Color>
                                </Style>
                              </TextRun>
                            </TextRuns>
                            <Style>
                              <TextAlign>Left</TextAlign>
                            </Style>
                          </Paragraph>
                        </Paragraphs>
                        <rd:DefaultName>Textbox2</rd:DefaultName>
                        <Style>
                          <Border>
                            <Color>White</Color>
                            <Style>None</Style>
                            <Width>0.5pt</Width>
                          </Border>
                          <BottomBorder>
                            <Color>#4e648a</Color>
                            <Style>Solid</Style>
                            <Width>1pt</Width>
                          </BottomBorder>
                          <LeftBorder>
                            <Color>LightGrey</Color>
                            <Style>Solid</Style>
                            <Width>1pt</Width>
                          </LeftBorder>
                          <RightBorder>
                            <Color>LightGrey</Color>
                            <Style>Solid</Style>
                          </RightBorder>
                          <BackgroundColor>White</BackgroundColor>
                          <VerticalAlign>Middle</VerticalAlign>
                          <PaddingLeft>2pt</PaddingLeft>
                          <PaddingRight>2pt</PaddingRight>
                          <PaddingTop>2pt</PaddingTop>
                          <PaddingBottom>6pt</PaddingBottom>
                          <WritingMode>Rotate270</WritingMode>
                        </Style>
                      </Textbox>
                    </CellContents>
                  </TablixCornerCell>
                </TablixCornerRow>
              </TablixCornerRows>
            </TablixCorner>
            <TablixBody>
              <TablixColumns>
                <TablixColumn>
                  <Width>0.69072cm</Width>
                </TablixColumn>
              </TablixColumns>
              <TablixRows>
                <TablixRow>
                  <Height>0.64295cm</Height>
                  <TablixCells>
                    <TablixCell>
                      <CellContents>
                        <Textbox Name="Textbox65">
                          <KeepTogether>true</KeepTogether>
                          <Paragraphs>
                            <Paragraph>
                              <TextRuns>
                                <TextRun>
                                  <Value>=IIF(Fields!CountNewVersionED.Value = -1, " ", Fields!CountNewVersionED.Value)</Value>
                                  <Style>
                                    <FontFamily>Tahoma</FontFamily>
                                    <FontSize>8pt</FontSize>
                                    <Color>=SWITCH(Fields!Sender.Value = Fields!Recipient.Value AND Fields!CountNewVersionED.Value = 0, "#a6a6a6",Fields!Sender.Value &lt;&gt; Fields!Recipient.Value AND Fields!CountNewVersionED.Value = 0, "White", Fields!CountNewVersionED.Value &gt;0 AND Fields!CountNewVersionED.Value &lt; 3,"Black", Fields!CountNewVersionED.Value &gt;= 3, "DarkGreen")</Color>
                                  </Style>
                                </TextRun>
                              </TextRuns>
                              <Style>
                                <TextAlign>Center</TextAlign>
                              </Style>
                            </Paragraph>
                          </Paragraphs>
                          <rd:DefaultName>Textbox58</rd:DefaultName>
                          <Style>
                            <Border>
                              <Color>LightGrey</Color>
                              <Style>Solid</Style>
                            </Border>
                            <TopBorder>
                              <Width>1.25pt</Width>
                            </TopBorder>
                            <LeftBorder>
                              <Style>None</Style>
                            </LeftBorder>
                            <RightBorder>
                              <Style>None</Style>
                            </RightBorder>
                            <BackgroundColor>=Switch( Fields!SenderGuid.Value = Fields!RecipientGuid.Value, "#a6a6a6", Fields!CountNewVersionED.Value  &gt; 2,"#"+Format(209-CInt(70*Fields!CountNewVersionED.Value/Variables!MaxCountED.Value), "X2")+""+Format(223-CInt(70*Fields!CountNewVersionED.Value/Variables!MaxCountED.Value), "X2")+""+Format(180-CInt(80*Fields!CountNewVersionED.Value/Variables!MaxCountED.Value), "X2"), Fields!SenderGuid.Value &lt;&gt; Fields!RecipientGuid.Value AND Fields!CountNewVersionED.Value  &lt;=2 , "White")</BackgroundColor>
                            <VerticalAlign>Middle</VerticalAlign>
                            <PaddingLeft>4pt</PaddingLeft>
                            <PaddingRight>2pt</PaddingRight>
                            <PaddingTop>2pt</PaddingTop>
                            <PaddingBottom>2pt</PaddingBottom>
                          </Style>
                        </Textbox>
                      </CellContents>
                    </TablixCell>
                  </TablixCells>
                </TablixRow>
              </TablixRows>
            </TablixBody>
            <TablixColumnHierarchy>
              <TablixMembers>
                <TablixMember>
                  <Group Name="ColumnGroup">
                    <GroupExpressions>
                      <GroupExpression>=Fields!RecipientGuid.Value</GroupExpression>
                    </GroupExpressions>
                    <PageBreak>
                      <BreakLocation>StartAndEnd</BreakLocation>
                    </PageBreak>
                  </Group>
                  <SortExpressions>
                    <SortExpression>
                      <Value>=Fields!RankB.Value</Value>
                    </SortExpression>
                  </SortExpressions>
                  <TablixMembers>
                    <TablixMember>
                      <TablixHeader>
                        <Size>7.02345cm</Size>
                        <CellContents>
                          <Textbox Name="Textbox62">
                            <KeepTogether>true</KeepTogether>
                            <Paragraphs>
                              <Paragraph>
                                <TextRuns>
                                  <TextRun>
                                    <Value>=Fields!Recipient.Value</Value>
                                    <Style>
                                      <FontFamily>Tahoma</FontFamily>
                                      <FontSize>8pt</FontSize>
                                      <Color>Gray</Color>
                                    </Style>
                                  </TextRun>
                                </TextRuns>
                                <Style />
                              </Paragraph>
                            </Paragraphs>
                            <rd:DefaultName>Textbox58</rd:DefaultName>
                            <Style>
                              <Border>
                                <Color>LightGrey</Color>
                                <Style>Solid</Style>
                              </Border>
                              <TopBorder>
                                <Style>None</Style>
                                <Width>1.25pt</Width>
                              </TopBorder>
                              <BottomBorder>
                                <Color>#4e648a</Color>
                                <Style>Solid</Style>
                              </BottomBorder>
                              <LeftBorder>
                                <Style>None</Style>
                              </LeftBorder>
                              <RightBorder>
                                <Style>None</Style>
                              </RightBorder>
                              <BackgroundColor>White</BackgroundColor>
                              <VerticalAlign>Middle</VerticalAlign>
                              <PaddingLeft>4pt</PaddingLeft>
                              <PaddingRight>2pt</PaddingRight>
                              <PaddingTop>2pt</PaddingTop>
                              <PaddingBottom>2pt</PaddingBottom>
                              <WritingMode>Rotate270</WritingMode>
                            </Style>
                          </Textbox>
                        </CellContents>
                      </TablixHeader>
                    </TablixMember>
                  </TablixMembers>
                </TablixMember>
              </TablixMembers>
            </TablixColumnHierarchy>
            <TablixRowHierarchy>
              <TablixMembers>
                <TablixMember>
                  <Group Name="RowGroup">
                    <GroupExpressions>
                      <GroupExpression>=Fields!SenderGuid.Value</GroupExpression>
                    </GroupExpressions>
                  </Group>
                  <SortExpressions>
                    <SortExpression>
                      <Value>=Fields!RankA.Value</Value>
                    </SortExpression>
                  </SortExpressions>
                  <TablixHeader>
                    <Size>6.49316cm</Size>
                    <CellContents>
                      <Textbox Name="Textbox59">
                        <KeepTogether>true</KeepTogether>
                        <Paragraphs>
                          <Paragraph>
                            <TextRuns>
                              <TextRun>
                                <Value>=Fields!Sender.Value</Value>
                                <Style>
                                  <FontFamily>Tahoma</FontFamily>
                                  <FontSize>8pt</FontSize>
                                  <Color>DimGray</Color>
                                </Style>
                              </TextRun>
                            </TextRuns>
                            <Style />
                          </Paragraph>
                        </Paragraphs>
                        <rd:DefaultName>Textbox58</rd:DefaultName>
                        <Style>
                          <Border>
                            <Color>LightGrey</Color>
                            <Style>Solid</Style>
                          </Border>
                          <TopBorder>
                            <Width>1.25pt</Width>
                          </TopBorder>
                          <LeftBorder>
                            <Style>None</Style>
                          </LeftBorder>
                          <RightBorder>
                            <Width>0.5pt</Width>
                          </RightBorder>
                          <BackgroundColor>=Switch(Fields!CountActiveCommunications.Value &gt; 2, "#d7e4bd", Fields!CountActiveCommunications.Value &gt; 0 AND Fields!CountActiveCommunications.Value &lt;= 2, "#ffff99", Fields!CountActiveCommunications.Value = 0,"#fcd5b5")</BackgroundColor>
                          <VerticalAlign>Middle</VerticalAlign>
                          <PaddingLeft>4pt</PaddingLeft>
                          <PaddingRight>2pt</PaddingRight>
                          <PaddingTop>2pt</PaddingTop>
                          <PaddingBottom>2pt</PaddingBottom>
                        </Style>
                      </Textbox>
                    </CellContents>
                  </TablixHeader>
                  <TablixMembers>
                    <TablixMember>
                      <TablixHeader>
                        <Size>1.14048cm</Size>
                        <CellContents>
                          <Textbox Name="Textbox3">
                            <KeepTogether>true</KeepTogether>
                            <Paragraphs>
                              <Paragraph>
                                <TextRuns>
                                  <TextRun>
                                    <Value>=Fields!CountActiveCommunications.Value</Value>
                                    <Style>
                                      <FontFamily>Tahoma</FontFamily>
                                      <FontSize>8pt</FontSize>
                                      <Color>DimGray</Color>
                                    </Style>
                                  </TextRun>
                                </TextRuns>
                                <Style>
                                  <TextAlign>Center</TextAlign>
                                </Style>
                              </Paragraph>
                            </Paragraphs>
                            <rd:DefaultName>Textbox3</rd:DefaultName>
                            <Style>
                              <Border>
                                <Color>LightGrey</Color>
                                <Style>Solid</Style>
                              </Border>
                              <TopBorder>
                                <Width>1.25pt</Width>
                              </TopBorder>
                              <RightBorder>
                                <Width>0.5pt</Width>
                              </RightBorder>
                              <BackgroundColor>White</BackgroundColor>
                              <VerticalAlign>Middle</VerticalAlign>
                              <PaddingLeft>4pt</PaddingLeft>
                              <PaddingRight>2pt</PaddingRight>
                              <PaddingTop>2pt</PaddingTop>
                              <PaddingBottom>2pt</PaddingBottom>
                            </Style>
                          </Textbox>
                        </CellContents>
                      </TablixHeader>
                      <TablixMembers>
                        <TablixMember>
                          <TablixHeader>
                            <Size>0.93367cm</Size>
                            <CellContents>
                              <Textbox Name="Textbox5">
                                <KeepTogether>true</KeepTogether>
                                <Paragraphs>
                                  <Paragraph>
                                    <TextRuns>
                                      <TextRun>
                                        <Value>=Fields!ALLCountNewVersionED.Value</Value>
                                        <Style>
                                          <FontFamily>Tahoma</FontFamily>
                                          <FontSize>8pt</FontSize>
                                          <Color>DimGray</Color>
                                        </Style>
                                      </TextRun>
                                    </TextRuns>
                                    <Style>
                                      <TextAlign>Center</TextAlign>
                                    </Style>
                                  </Paragraph>
                                </Paragraphs>
                                <rd:DefaultName>Textbox5</rd:DefaultName>
                                <Style>
                                  <Border>
                                    <Color>LightGrey</Color>
                                    <Style>Solid</Style>
                                  </Border>
                                  <TopBorder>
                                    <Width>1.25pt</Width>
                                  </TopBorder>
                                  <LeftBorder>
                                    <Width>1pt</Width>
                                  </LeftBorder>
                                  <RightBorder>
                                    <Width>0.5pt</Width>
                                  </RightBorder>
                                  <BackgroundColor>White</BackgroundColor>
                                  <VerticalAlign>Middle</VerticalAlign>
                                  <PaddingLeft>4pt</PaddingLeft>
                                  <PaddingRight>2pt</PaddingRight>
                                  <PaddingTop>2pt</PaddingTop>
                                  <PaddingBottom>2pt</PaddingBottom>
                                </Style>
                              </Textbox>
                            </CellContents>
                          </TablixHeader>
                        </TablixMember>
                      </TablixMembers>
                    </TablixMember>
                  </TablixMembers>
                </TablixMember>
              </TablixMembers>
            </TablixRowHierarchy>
            <RepeatColumnHeaders>true</RepeatColumnHeaders>
            <RepeatRowHeaders>true</RepeatRowHeaders>
            <FixedColumnHeaders>true</FixedColumnHeaders>
            <FixedRowHeaders>true</FixedRowHeaders>
            <DataSetName>DataSet1</DataSetName>
            <Top>1.84666cm</Top>
            <Height>7.6664cm</Height>
            <Width>9.25803cm</Width>
            <ZIndex>6</ZIndex>
            <Style>
              <Border>
                <Style>None</Style>
              </Border>
            </Style>
          </Tablix>
        </ReportItems>
        <Height>95.13066mm</Height>
        <Style>
          <Border>
            <Style>None</Style>
          </Border>
        </Style>
      </Body>
      <Width>278.25789mm</Width>
      <Page>
        <PageFooter>
          <Height>7.05556mm</Height>
          <PrintOnFirstPage>true</PrintOnFirstPage>
          <PrintOnLastPage>true</PrintOnLastPage>
          <ReportItems>
            <Textbox Name="ExecutionTime">
              <CanGrow>true</CanGrow>
              <CanShrink>true</CanShrink>
              <KeepTogether>true</KeepTogether>
              <Paragraphs>
                <Paragraph>
                  <TextRuns>
                    <TextRun>
                      <Value>=Globals!ExecutionTime</Value>
                      <Style>
                        <FontFamily>Yu Gothic UI</FontFamily>
                      </Style>
                    </TextRun>
                  </TextRuns>
                  <Style>
                    <TextAlign>Left</TextAlign>
                  </Style>
                </Paragraph>
              </Paragraphs>
              <rd:DefaultName>ExecutionTime</rd:DefaultName>
              <Top>0.70556mm</Top>
              <Left>27.40875mm</Left>
              <Height>6.35mm</Height>
              <Width>36.07153mm</Width>
              <Style>
                <Border>
                  <Style>None</Style>
                </Border>
                <PaddingRight>2pt</PaddingRight>
                <PaddingTop>2pt</PaddingTop>
                <PaddingBottom>2pt</PaddingBottom>
              </Style>
            </Textbox>
            <Textbox Name="ExecutionTime2">
              <CanGrow>true</CanGrow>
              <CanShrink>true</CanShrink>
              <KeepTogether>true</KeepTogether>
              <Paragraphs>
                <Paragraph>
                  <TextRuns>
                    <TextRun>
                      <Value>Отчет создан в:</Value>
                      <Style>
                        <FontFamily>Yu Gothic UI</FontFamily>
                      </Style>
                    </TextRun>
                  </TextRuns>
                  <Style>
                    <TextAlign>Right</TextAlign>
                  </Style>
                </Paragraph>
              </Paragraphs>
              <rd:DefaultName>ExecutionTime</rd:DefaultName>
              <Top>0.70556mm</Top>
              <Left>0mm</Left>
              <Height>6.35mm</Height>
              <Width>27.40875mm</Width>
              <ZIndex>1</ZIndex>
              <Style>
                <Border>
                  <Style>None</Style>
                </Border>
                <PaddingLeft>2pt</PaddingLeft>
                <PaddingTop>2pt</PaddingTop>
                <PaddingBottom>2pt</PaddingBottom>
              </Style>
            </Textbox>
          </ReportItems>
          <Style>
            <Border>
              <Style>None</Style>
            </Border>
          </Style>
        </PageFooter>
        <PageHeight>29.7cm</PageHeight>
        <PageWidth>21cm</PageWidth>
        <InteractiveHeight>0cm</InteractiveHeight>
        <InteractiveWidth>21cm</InteractiveWidth>
        <LeftMargin>2cm</LeftMargin>
        <RightMargin>2cm</RightMargin>
        <TopMargin>2cm</TopMargin>
        <BottomMargin>2cm</BottomMargin>
        <ColumnSpacing>0.13cm</ColumnSpacing>
        <Style />
      </Page>
    </ReportSection>
  </ReportSections>
  <ReportParameters>
    <ReportParameter Name="DataStart">
      <DataType>DateTime</DataType>
      <DefaultValue>
        <Values>
          <Value>=DateSerial(Year(TODAY), Month(TODAY),"1")</Value>
        </Values>
      </DefaultValue>
      <Prompt>Дата начала</Prompt>
    </ReportParameter>
    <ReportParameter Name="DataEnd">
      <DataType>DateTime</DataType>
      <DefaultValue>
        <Values>
          <Value>=DateSerial(Year(Now()), Month(Now()), Day(Now()))</Value>
        </Values>
      </DefaultValue>
      <Prompt>Дата окончания</Prompt>
    </ReportParameter>
  </ReportParameters>
  <Variables>
    <Variable Name="MaxCountED">
      <Value>=MAX(Fields!MaxCountED.Value, "DataSet2")</Value>
    </Variable>
  </Variables>
  <rd:ReportUnitType>Cm</rd:ReportUnitType>
  <rd:ReportID>21b49ffa-40d0-41df-b8a2-4c5852e84d34</rd:ReportID>
</Report>